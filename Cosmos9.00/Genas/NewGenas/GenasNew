
1) いわゆるB近似のサイズNeについて. Cosmosでfull M.Cをやらずに
	解析解をつないで，サイズを求める場合を想定します．
	(ハイブリッドな計算)
	
	例えば，1ryがガンマの場合．これをいきなり解析解につなぐと，
	解析解は揺らぎを平均化したものだから，何千
	のeventを作ろうとも，まったく同じトランジション
	カーブが得られて，ほとんど実用にはなりません．

	そこで，ガンマ線が電子になった段階で解析解につなぐことが
	考えられます．すると，対生成の起こるまでの距離の揺らぎ
	と，電子対にどのようにエネルギーが配分されるかの揺らぎ
	が入ります．これでもその後,電子がどのように発達するか
	の揺らぎは入りません．

	そこで，もう少し，粒子のエネルギーが細分化されるまで
	解析解につなぐのを待つというのが考えられます．あまり
	待っていると，結局full M.Cになるので，十分な揺らぎが
	入るまで細分化されるのを待つということになります．この
	値として，十分と思われるのは親のエネルギーのEr=1/100です．
	(もう少し大きな値でもごまかしはきくでしょうが)．また，	
	ガンマ線は突っ込みの揺らぎが大きいので，必ず電子に
	なった段階で解析解につなぐことも必要です．

	さてこうして，粒子のエネルギーが細分化されると，なかには
        10MeVとか100MeVとかの電子も出来ます．これらは，解析解
	につなぐとしても，解析解の精度も悪い所なのと，空気シャワー
	と呼べるような，シャワーを作らないので，捨てることにします．
	どのエネルギー以下ならすてるかは問題ですが，今はEt=1GeV以下なら
	すてるのが標準です．(これはちょっと高すぎたかなと思ってますが)

	では，100 GeVの電子やガンマ線を入射させてハイブリッドな方法で
	Neを求めるとどうなるか?
	解析解につなぐのは100 x Er = 1 GeVまで待つ．
	しかし，1GeV以下は捨てるので，Neは0という答が出ます．(甲南の学生
	さんがやった誤り)．まともなNeを求めるにはErを大きくするか
	(限度は~1/20だろうが，揺らぎがまともに入らなくなる)， Etを
	小さくするか．しかし，いずれも信頼できるNeが求まるとは保証
	できない領域になります．

	ハイブリッドな方法はどのエネルギーなら安心か?  シャワーの
	発達に無視してよい粒子のエネルギーはおよそ親の10^-4です．したがって，	
	Et x 10 ^4 =10 TeV以上の 電子やガンマ線なら，ハイブリッドな方法が
	"安心"(以下示すように安心はできない)して使えると言うことになります．

	1ryがハドロンの場合はもともと電子になるのはかなり親のエネルギーが
	細分化された段階なのと，沢山の粒子が一度に発生するので， Erは
	1として良い．それでも，数TeV以下にハイブリッドな方法を適用するのは
	問題です．

	結論．10TeV以下のシャワーは必ずFull M.Cでやる．今の計算機なら
	それはまったく問題なく出来るハズ．Et=100MeVまで落とせば，
	10TeV->1TeVとすることは出来そうだが．今のCosmosではEt=1 GeV
	は固定．

2) 10 TeV以上なら，ハイブリッドな方法で求めたサイズを信頼してよいか?
	ここで注意が必要なのは，B近似の解析解は1次元の発達を想定して
	いることです．また1GeV以上の電子から解析解につなぐので，
	(1GeV以上の粒子は空気シャワーの広がりから見れば，小さいので)
	結果は1次元の計算で出したもの，と解釈してよいことになります．
	(マスターの学生さん，1GeVの電子がどのくらい広がって降ってくるか
	1分以内に答が出せますか?)
	
	通常B近似の解ではクリティカル・エネルギーEc=76MeVとかで計算が
	行われるようです．この値で，上記のハイブリッドな計算と，
	1次元 Full M.C(Emin~1MeV)が合うかどうかですが，これは，ぴったりと合います．
	(Full M.Cにはクリティカル・エネルギーという概念はないことに
	注意)．

	それでは3次元Full M.CとEc=76MeVのハイブリッド計算が合うかというと
	それは合いません．粒子数はシャワー軸に垂直な平面で数えるとすると
	軸から離れた所に降ってきた粒子の経た距離(トラックレングス)は，
	中心の所のトラックレングスよりかなり長くなっているからです．
	この効果は，すぐ分かるように，3次元ではシャワーは1次元より
	早く発達すると言うことです．また，一番肝心なシャワー極大付近
	は粒子数が1次元より少なくなるという効果に現れます．
	このNe(max)の減少は~20%にも及ぶので，1次元の値をそのまま使うと
	とんでもないことになります．
	
	そこでハイブリッドな計算を3次元の値に合わせるには，補正が必要
	ということになります．まずはシャワー極大のあたりを合わせると
	すると，Ecをもっと大きな値にする必要がある，ということになります．
	Ne(max) ~(E0/Ec)なので，~20%補正するには，Ec~91MeVとしないと
	合わないことになります．しかしこうすると，極大付近は合うが，
	他ではハイブリッド計算のNeがやたらに小さくなるということになり
	ます．従って，全領域で合わせるには，シャワーの年齢によって
	補正する数値を求める必要が出てきます．

	リンズレーはさすがにこの辺りのことに気がついていて(彼は全トラック
	レングスに何を掛ければ親のエネルギーになるかという立場から
	考察したのですが)76MeVというのは低過ぎ，81MeV位にしないといけない，	
	といってます．(CosmosのEcは昔76MeV,現在のdefaultは81MeVになって
	いるハズです．)

        ****************************************
	現在のCosmosではこのような補正は一切されてないので，ハイブリッドな
	計算から出したNeの値には十分な注意が必要です．また，昔の計算は
	Ec=76MeVで行われたことにも注意して下さい．
        ***************************************

3) 電子だけで話をしていたのでは，20~30年前のレベルです．観測にはガンマ線やミューオン(まあ多くの
  場合はハドロンは無視出来る)が利いてきます．これらがどのように測定器の中で発達し，
  観測に利いてくるかをちゃんとやらないといけないことになります．チベットでは鉛をおいて
  この効果を積極的に利用しているので，なおさらです．
  この点に関しても，GENAS以来の改善が見られません．前にも書いたように，	
  これはマスターの兵(つわもの)がやれば1週間の仕事ですが ．．．
	任意のエネルギー,角度でガンマ線，電子，ミューオンが
	チベットの検出器に入ってきた時のシンチ内のエネルギーロス
	を計算して，出力するルーチンを作る．(もちろん揺らぎがあるので
	それを考慮したM.Cルーチンです)．
	これを毎回full M.Cでやっていると大変なんで，高速ルーチンを作る訳です．
	これはEpicsですぐに作れる．(シンチの発光量はエネルギーロスが大きくなると
	それに比例しない効果はEpicsの中に入っています)．エネルギーロスはミューオンの
	シングルピークで換算して，粒子数に変換しておくのが良い．

	検出器内での更なる効果(シンチのどこに落ちたかでの発光量の違い，
		ホトマルへの光量の違い，
		複数の粒子が来た場合のタイミングの問題などは別の
		所で考慮する)．

        ******************
	実験との対応はすべて，シングルピークの対応関係によるので，どのように
	シングルピークを観測するのか(角度の条件)をはっきりしておく．これを間違うと
	すぐにフラックスは20%位変わってしまうので要注意．また夜と昼での
	シングルピークの位置がずれるなども，細かく解析に反映させないと
	信頼出来るフラックスは求まらない．
	******************

	 ^^^^^^^^^^^^^^^^^^^	
	この点に関するGENASでの問題点．
		ミューオンが入ってない．ガンマと電子をまとめてレスポンスを
	計算している．(あるNeが降ってきたら，そこにはガンマの寄与がこれこれあるので，
	それをこみにした，レスポンスを計算しているーーこれは特に問題では
	ないかも知れないが，ガンマと電子は分けた方が良いだろう)．
	エネルギーロスの計算にLandau-Vavilov-Gaussianの揺らぎが入ってない．
        ^^^^^^^^^^^^^^^^^^
4)結局どうすれば良いか．

	10TeV以下はFull M.Cで3)の検出器レスポンスと接続すれば完璧です．
	現在の計算機パワーからすれば，これはまったく可能な領域です．
	そのためにも3)のルーチンを早急に作るべきです．

      1000TeVとなると，10000例のレベルでFull M.Cをやるのはシンドイので，
	やはり，GENASを改良すべきでしょう．まあ1TeV位でもGENASが使える
	ようにする心意気でやって良いでしょうが，10TeV以下のfull of
	fluctuationのシャワーをGENASのような方法で再現するのはなかなか
	大変だというのが前やったときの感想です．

	重要なのは検出器のレスポンスなので，ハイブリッドなNeなどは
	つまるところ，どうでもいいといえば言える訳です．いわば触媒
	みたいなもので，10倍違ったNeでも，このNeなら，電子と
	ガンマ(ミュー)が検出器にこのようなレスポンスを出すという，
	対応関係がのが分かれば良い．しかし，これは極論で，
	やはり，本当の3次元のNeとあっているのが
	良いことに変わりはない．その意味ではまずは
	ハイブリッド・シャワーの年齢と補正因子を求めるのが最初の仕事かも．
	この補正因子が分かれば(1ryのエネルギーによって変わらない
	あるいは，依存性が分かるとして)，あとはハイブリッドなシャワーを
	沢山発生させて，揺らぎの問題を観察出来ます．この後のプロセスは
	既にknow howがあるので，GENASの改良は簡単．ミューに関しても
	ある程度のknow howは蓄積されてます．

	山東のZhang氏がマスター論文としてGENASの改良をやらすといっていたが
	どうもその気配がないので，やはり日本で誰かがやらないとダメだろう．
	ねえ堀田先生．

大分長くなったので，これにて打ち止め．
現在多重発生のthresholdから，高エネルギーまで
一貫して使えるfashonableな良いコードが手に入ったので，Cosmosへの組み込みを試みています．
乞うご期待．
老婆心の注意．Corsikaを使っている人へ．Corsikaは知っているかぎり， 90GeV以下でGheisha
というコードを使っています．Gheishaは特に指定すればCosmosでも使えるようになっていますが，
defaultではありません．Gheishaはエネルギー保存，電荷の保存などがされない，困ったコードです．
そのへんを知らないで使うと，場合によってはとんでもない結果がでるので，注意が必要です．




=========================================================================

2)まずはガンマ線1ryの場合をせめる．

方針は，シャワーを何らかの方法で規格化して，
なるべく揺らぎの少ない形にする．その平均の
形の規則性を見いだす．それがわかったら，
その規則に従うシャワーを発生させ，それに揺らぎを
つけ加えるルーチンを作れば高速シャワー発生ルーチンが
完成すると言う寸法である．

ガンマ線1ryの場合にはミューの成分を問題にする事はないと
思われるので，photo hadron production はoffのままでいいだろう．


したがって，調べる成分はガンマと電子である．

これまでの方法は，
等間隔に設けた観測点での観測値を用い，シャワーの
遷移曲線を重心(COG)で揃えて規格化する事である．
これで，揺らぎは見かけ上相当少なくなる．
必要な規則的なカーブは規格化したあとの平均の
カーブである． ( t^a exp(- bt^c)のような
カーブが良くフィットする; linear exponential)
揺らぎの計算に必要なものは
1)その平均のカーブから観測値がどのように
揺らいでいるかの分布形． log-gaussあるいは
	2重log-gaussなどが良くフィットした?
2)COGの分布形である．これもたぶん linear
exponentialだったか．

遷移曲線は例えば1MeV以上の粒子について求める
として，他に必要になるのは，各(規格化した)深さ
でのエネルギースペクトルである．

各深さを表すパラメータとして，1次元の
シャワー理論で出てくる，シャワーエイジ，を
パラメータとして使うと，うまく整理できるであろう．

3次元シャワーとしてはlateral 分布を求めておく事も
忘れてはならない．


上記のような量を表す各種パラメータの1ryエネルギー
依存性が分かれば，ほぼやる事は完成である．


10TeV以下はfull M.Cですべてやる．

10TeV以上は，full M.CとHybridシャワー発生を同時に	
行い，Hybridの値に何をかければ，3次元の値になるかの
規則性を見いだす．エネルギーの高い所は，full M.Cで
統計を稼ぐのは困難なので，Hybridだけでシャワーを
作り，上記の規則性を適用する．












muonのGENAS用システマティックス
大昔にトライしたときの古文書が出てきたのでひもとくと，
以下のような方針が多少は役に立ちそうだ。




要件:
1ryの種類，Energy E0, 角度(sec theta or cos theta) 観測高度(depth) x，core distantce Rが与えられた時，ミューの個数密度がわかり，(エネルギー)， 到着時間がサンプリングできること．

1)muをパラメタライズするにはNeを使うのは良くない．
 	 --> E0, COG(ASトランジションのCenter of Gravity)が良い
	     パラメータである．

   Nmuの平均値<Nmu>のトランジションは以下のような関数で非常に良く表せる．

ただし，係数はあくまで目安で，正しいシミュレーションで較正する必要あり．



 Nmu(z) = a z^m  exp(-b z^n)

where  z = x/xm;  x is depth
       xm   = 66.7log10(E0/TeV) + 625 (g/cm^2)
       a = Nm exp(b)
       Nm = 29 E0^0.8 cos^0.61
       b=3.7
       m = bn
       n =0.606E0^0.0417

sec <=1.5位までgood. sec=2では補正が必要かも．

これは  x>150 g/cm^2からかなり良い近似式となるが，x>500くらいだけを
目標にするなら，sec > 1.5も含めて良い式がつくれるかも．
sec  ~ 2では
	b=9.5
	xm=  ( 66.7log10(E0/TeV) + 600) *0.55
        n  =0.606E0^0.0417 * 0.55
程度に係数を変える必要ある????
heavyの時はE0を操作する必要があるだろう(あるいは，heavyが核子に
分裂してから，protonの式を使う)．

さてこれで平均の<Nmu>は決まるが，揺らぎをどういれるか．
Nmu/<Nmu>は非常に良いGauss分布をする．ただし，このGauss分布の
sigmaを求めて単にsamplingしても，shower発達との相関が入らないで
ダメ．
そこで
  Nmu/<Nmu>とCOGの相関を取ると， depth > 400では

define    <<Nmu>> = < Nmu/<Nmu> >

とすると
          <<Nmu>> = (COG/ A)^B
で良く近似できる。そして、揺らぎは
<<Nmu>>を中心とするgauss分布で良く近似できる事が分かる．
 (<<Nmu>>は0.7 ~ 1.5くらいまで変化する．)
ただし，A, Bはsec, E0, depthなどの緩い関数で，
	 A ~ 320 程度，
	 B ~ 0.22 ~ 0.35
      Gauss 分布のsigma ~ 0.3程度
となる．A, B，sigmaをうまくパラメタライズすれば
1)1ry, E0, sec, depth より<Nmu>を求め，
2) <<Nmu>>をCOG,A, Bなどから求める．
3) sigmaと<<Nmu>>から Nmu/<Nmu>をsampleする．
4) <Nmu>が分かっているので，Nmuが求まる．となる．
	これでシャワーの発達と十分相関のあるNmuのsamplingが
	可能．

-------第1段終了


方針; 運動エネルギーが50 MeV以下のmuはほとんどない．多くは100MeV以上．
	これらは全て，検出器を通り抜ける．またシンチ中での
	energy depositのエネルギー依存性もこの領域では少ない．
	そこでまずはエネルギー分布については目をつぶる．

広がり Rmu:
<Rmu>を求め，COGとの相関をみる．
  <Rmu>  ~ exp(-COG/B)

B ~ 700 程度 (観測場所が浅い所では小さく(depth=200 g/cm^2 -> 440)，
	深い所では大きくなる(deth =1000 g/cm2-> 790).

def X=R/<Rmu>の分布はGaussでなく

 A x^n exp(-bx^m)

で良く近似できる．Aはノーマリゼンションで決めれば良い．
 あとは n, b, mのシステマティックスを追求．
 n = 0.4 ~2   b ~3  m ~0.5
あたりになるだろう．特に X > 0.1 ではほとんどユニバーサル
な形になるので，x>0.1 と X<0.1で分けた方がいいかも．
(X<0.1というのは，おおよそ30m 以下程度).











時間分布; T(nsec)

最低 R との相関が必要．

<T>g (gは幾何平均の意味)は
 <T>g  ~A R^B   (R in m)
で良く近似できる． A = A(COG) = 0.01,  B=B(COG) ~ 1.7程度か

def X=T/<T>gを表す関数はなかなか難物で，簡単なのが見つからない．
成功を収めたのは，
def Y=log10(X)で分布をとり，2つのGaussを足すというものである．

 dN/dY  = Gauss1(Y) + Gauss2(Y) (面積1にnormalize)

 Gauss(Y) = A exp(-( (Y-<Y>)/S)^2/2)

<Y> = <Y>(R)は1,2に共通．
．  A=A(R),  S=S(R)は1，2で別の係数．
R依存性は大きい．目安として，

<Y> = 0.5 x log10(R) - 1.4 程度.

( as R 10 -->1000 )で目安として
A1 = 0.6 --> 1.0
S1 = 0.9 --> 0.4
A2 = 1.4 ---> 1.0
S2 = 0.9 --> 0.4
A1 =  0.6  ~ 1
といった所か．